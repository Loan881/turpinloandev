<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Panier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#fff; --text:#111; --muted:#2d2d2d; --accent:#1E155C; }
    *{box-sizing:border-box}
    html,body{height:100%; overflow-x:hidden}
    body{margin:0; font-family:"Playfair Display", serif; color:var(--text); background:var(--bg); line-height:1.55;}
    a{color:inherit; text-decoration:none}
    .container{width:min(1200px, 92%); margin-inline:auto}
    /* Topbar */
    header{background:#fff; position:sticky; top:0; z-index:40; border-bottom:1px solid rgba(0,0,0,.05); backdrop-filter:saturate(160%) blur(6px)}
    .topbar{position:relative; display:flex; align-items:center; justify-content:center; gap:12px; padding:12px 0; min-height:60px}
    .back{position:absolute; left:0; top:50%; transform:translateY(-50%)}
    .back a{display:inline-flex; padding:12px; border-radius:8px}
    .title{position:absolute; left:50%; transform:translateX(-50%); margin:0; font-weight:700; font-size:22px}
    /* Layout */
    section{padding:32px 0}
    .grid{ display:grid; grid-template-columns: 1fr minmax(260px, 360px); gap: clamp(16px, 3.5vw, 28px); align-items:start; }
    @media (max-width: 880px){ .grid{ grid-template-columns:1fr; } }
    .h2{font-weight:700}
    .rule{width:225px; height:1px; background:#000; margin:8px 0 18px}
    .muted{color:var(--muted)}
    /* Liste */
    .list{display:grid; gap:12px}
    .row{display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; background:#fff}
    .thumb{width:92px; height:92px; border-radius:10px; overflow:hidden; background:#f4f4f6; border:1px solid rgba(0,0,0,.06)}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .meta{display:grid; gap:6px}
    .name{font-weight:700}
    .opt{font-size:.95rem; color:var(--muted)}
    .act{display:grid; gap:8px; justify-items:end}
    .qty{display:inline-grid; grid-auto-flow:column; gap:8px; align-items:center; border:1px solid rgba(0,0,0,.12); border-radius:999px; padding:4px 8px;}
    .qty button{ width:28px; height:28px; border-radius:50%; border:1px solid rgba(0,0,0,.12); background:#fff; cursor:pointer }
    .price{font-weight:800}
    .rm{background:transparent; border:none; color:#999; cursor:pointer; font-size:14px; text-decoration:underline}
    .empty{text-align:center; border:1px dashed rgba(0,0,0,.18); border-radius:12px; padding:28px}
    /* R√©sum√© */
    .summary{ position:sticky; top:84px; background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:14px 16px; display:grid; gap:10px }
    .rowline{display:flex; justify-content:space-between; gap:12px}
    .total{font-weight:800; font-size: clamp(1.05rem, 1vw + 1rem, 1.25rem)}
    .buttons{display:grid; gap:10px; margin-top:6px}
    .button{display:inline-block; background:var(--accent); color:#fff; border:1px solid #000; padding:12px 16px; border-radius:10px; font-size:14px; text-align:center; cursor:pointer}
    .ghost{display:inline-block; background:#fff; color:#111; border:1px solid rgba(0,0,0,.12); padding:12px 16px; border-radius:10px; font-size:14px; text-align:center; cursor:pointer}
    /* Debug (retire-le quand OK) */
    .debug{ position:fixed; right:14px; bottom:14px; z-index:50; width:min(420px, 94vw); background:#fff; border:1px dashed #bbb; border-radius:12px; padding:10px; font: 12px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .debug h4{ margin:0 0 6px; font-size:13px }
    .debug pre{ margin:0; white-space:pre-wrap; word-break:break-word; max-height:220px; overflow:auto; background:#fafafa; padding:8px; border-radius:8px }
    .debug .row{ display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap }
  </style>
</head>
<body>

  <!-- Top Bar -->
  <header>
    <div class="container topbar">
      <div class="back"><a href="produits.html" aria-label="Retour" title="Retour">‚Üê Retour</a></div>
      <h1 class="title">Panier</h1>
    </div>
  </header>

  <section>
    <div class="container">
      <div class="grid">
        <div>
          <h2 class="h2">Vos articles</h2>
          <div class="rule"></div>

          <div id="empty" class="empty" style="display:none">
            Votre panier est vide.
            <a class="button" href="produits.html" style="margin-left:10px">D√©couvrir les produits</a>
          </div>

          <div id="list" class="list" aria-live="polite"></div>
        </div>

        <aside class="summary" aria-label="R√©capitulatif">
          <div class="rowline"><span>Sous-total</span><strong id="subtotal">0 ‚Ç¨</strong></div>
          <div class="rowline muted"><span>Frais de port</span><span>Calcul√©s au paiement</span></div>
          <div class="rowline total"><span>Total</span><span id="total">0 ‚Ç¨</span></div>
          <div class="buttons">
            <button id="addDemo" class="ghost" type="button">+ Ajouter un article de test</button>
            <button id="clear" class="ghost" type="button">Vider le panier</button>
            <a class="button" href="checkout.html">Aller au paiement</a>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <!-- Debug helper -->
  <div class="debug" id="dbg" aria-live="polite">
    <div class="row">
      <button id="refresh" type="button">‚Üª Voir localStorage.cart</button>
      <button id="wipe" type="button">üóëÔ∏è Supprimer la cl√©</button>
    </div>
    <h4>localStorage.cart</h4>
    <pre id="dump"></pre>
  </div>

  <script>
    // ------- Utils monnaie / DOM
    const ‚Ç¨  = v => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format((Number(v)||0)/100);
    const el = id => document.getElementById(id);

    // ------- Cart I/O (plus tol√©rant)
    const KEY = 'cart';

    function readRaw(){
      try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
      catch { return []; }
    }
    function writeRaw(arr){
      try { localStorage.setItem(KEY, JSON.stringify(arr)); }
      catch { /* localStorage indisponible/quota plein */ }
    }

    // Normalise n'importe quelle forme {id, name, price, qty, image, option}
    function normalizeLine(l){
      if (!l) return null;

      // Accepte plus d'alias d'identifiants
      let id = l.id ?? l.productId ?? l.product_id ?? l.slug ?? l.sku ?? l.uid ?? l.ref ?? l.reference ?? null;
      const name = l.name ?? l.title ?? (id ? String(id) : null);

      // Fallback si pas d'ID : construit un ID stable depuis le nom + option
      if (!id && name) id = `${name}-${l.option ?? l.variant ?? ''}`.trim();
      if (!id) return null;

      // Quantit√©
      const qty = Math.max(1, parseInt(l.qty ?? 1, 10) || 1);

      // Prix: "19,90", 19.9 (euros) ou 1990 (cents)
      let price = l.price ?? l.unit_price ?? l.amount ?? 0;
      if (typeof price === 'string') price = price.replace(',', '.');
      price = Number(price);
      if (price < 10 && String(price).includes('.')) price = Math.round(price * 100); // euros ‚Üí cents
      else price = Math.round(price); // d√©j√† en cents (ou entier)

      return {
        id,
        name: name ?? id,
        price: Number.isFinite(price) ? price : 0,
        currency: (l.currency || 'EUR').toUpperCase(),
        image: l.image || 'https://picsum.photos/seed/placeholder/600/600',
        option: l.option ?? l.variant ?? '',
        qty
      };
    }

    function load(){
      const raw = readRaw();

      // Accepte tableau OU objet { id: item, ... }
      let arr = [];
      if (Array.isArray(raw)) arr = raw;
      else if (raw && typeof raw === 'object') arr = Object.values(raw);

      const norm = arr.map(normalizeLine).filter(Boolean);

      // Fusionne doublons (m√™me id + option)
      const map = new Map();
      for (const x of norm){
        const k = `${x.id}|${x.option||''}`;
        if (map.has(k)) map.get(k).qty += x.qty;
        else map.set(k, {...x});
      }
      return Array.from(map.values());
    }
    function save(lines){ writeRaw(lines); }

    // ------- Rendu
    function subtotal(lines){ return lines.reduce((s,l)=> s + l.price*l.qty, 0); }

    function render(){
      const list = el('list');
      const empty = el('empty');
      list.innerHTML = '';
      const lines = load();

      if (!lines.length){
        empty.style.display = 'block';
        el('subtotal').textContent = '0 ‚Ç¨';
        el('total').textContent = '0 ‚Ç¨';
        dump(); // debug
        return;
      }
      empty.style.display = 'none';

      lines.forEach((l, i) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="thumb"><img src="${l.image}" alt="${l.name}"></div>
          <div class="meta">
            <div class="name">${l.name}</div>
            ${l.option ? `<div class="opt">Variante : ${l.option}</div>` : ''}
            <button class="rm" data-i="${i}" aria-label="Retirer ${l.name}">Retirer</button>
          </div>
          <div class="act">
            <div class="qty" role="group" aria-label="Quantit√© ${l.name}">
              <button class="dec" data-i="${i}" aria-label="Diminuer">‚àí</button>
              <span aria-live="polite">${l.qty}</span>
              <button class="inc" data-i="${i}" aria-label="Augmenter">+</button>
            </div>
            <div class="price">${‚Ç¨(l.price * l.qty)}</div>
          </div>
        `;
        list.appendChild(row);
      });

      const st = subtotal(lines);
      el('subtotal').textContent = ‚Ç¨(st);
      el('total').textContent = ‚Ç¨(st);

      // D√©l√©gation des actions
      list.onclick = (e) => {
        const inc = e.target.closest('.inc');
        const dec = e.target.closest('.dec');
        const rm  = e.target.closest('.rm');
        if (!inc && !dec && !rm) return;

        const c = load();
        if (inc){ c[+inc.dataset.i].qty += 1; save(c); render(); return; }
        if (dec){ c[+dec.dataset.i].qty = Math.max(1, c[+dec.dataset.i].qty - 1); save(c); render(); return; }
        if (rm){  c.splice(+rm.dataset.i, 1); save(c); render(); return; }
      };

      dump(); // debug
    }

    // ------- Actions globales
    el('clear').onclick = () => { writeRaw([]); render(); };
    el('addDemo').onclick = () => {
      const c = load();
      c.push({
        id:'demo-article',
        name:'Article de test',
        price: 1990,        // 19,90 ‚Ç¨
        currency:'EUR',
        image:'https://picsum.photos/seed/demo-cart/800/800',
        option:'D√©mo',
        qty: 1
      });
      save(c); render();
    };

    // ------- Debug panneau
    function dump(){ el('dump').textContent = localStorage.getItem(KEY) || '[]'; }
    el('refresh').onclick = dump;
    el('wipe').onclick = () => { localStorage.removeItem(KEY); render(); };

    // ------- Init
    render();
  </script>
</body>
</html>
